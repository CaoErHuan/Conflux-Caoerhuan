<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="author" content="order by dede58.com" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>预拌混凝土供应链追踪溯源系统</title>
	<meta name="description" content="">
	<meta name="author" content="templatemo">

	<!--<link href='http://fonts.useso.com/css?family=Open+Sans:400,300,400italic,700' rel='stylesheet' type='text/css'>-->
	<link href="css/font-awesome.min.css" rel="stylesheet">
	<link href="css/bootstrap.min.css" rel="stylesheet">
	<link href="jqvmap/jqvmap.css" media="screen" rel="stylesheet" type="text/css" />
	<link href="css/templatemo-style.css" rel="stylesheet">

	<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
	<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
	<!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->

	<script type="text/javascript" src="//api.map.baidu.com/api?v=2.0&ak=FpwKaMXTKeWzAZn9B913bgrs3FkKgAUa"></script>
	<script src="https://unpkg.com/@metamask/detect-provider/dist/detect-provider.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>


</head>

<body>
<!-- Loader -->
	<!-- Left column -->
	<div class="templatemo-flex-row">
		<div class="templatemo-sidebar">
			<header class="templatemo-site-header">
				<!--	  <div class="square"></div>-->
				<h1>Conflux联盟链<br></br>预拌混凝土供应链追踪溯源系统</h1>
			</header>
			<div class="profile-photo-container">
				<img src="img/chainlink.jpg" alt="Profile Photo" class="img-responsive">
				<div class="profile-photo-overlay"></div>
			</div>
			<!-- Search box -->
			<form class="templatemo-search-form" role="search">
				<div class="input-group">
					<button type="submit" class="fa fa-search"></button>
					<input type="text" class="form-control" placeholder="Search" name="srch-term" id="srch-term">
				</div>
			</form>
			<div class="mobile-menu-icon">
				<i class="fa fa-bars"></i>
			</div>
			<nav class="templatemo-left-nav">
				<ul>
					<li><a href="index.html"><i class="fa fa-home fa-fw"></i>登录</a></li>
					<!--		<li><a href="data-visualization.html"><i class="fa fa-bar-chart fa-fw"></i>Charts</a></li>-->
					<!--		<li><a href="data-visualization.html"><i class="fa fa-database fa-fw"></i>Data Visualization</a></li>-->
					<li><a href="query.html" class="active"><i class="fa fa-map-marker fa-fw"></i>查询</a></li>
					<!--		<li><a href="manage-users.html"><i class="fa fa-users fa-fw"></i>Manage Users</a></li>-->
					<li><a href="preferences.html"><i class="fa fa-sliders fa-fw"></i>节点配置</a></li>
					<!--		<li><a href="login.html"><i class="fa fa-eject fa-fw"></i>Sign Out</a></li>-->
				</ul>
			</nav>
		</div>
		<!-- Main content -->
		<div class="templatemo-content col-1 light-gray-bg">
			<div class="templatemo-top-nav-container">
				<div class="row">
					<nav class="templatemo-top-nav col-lg-12 col-md-12">
						<ul class="text-uppercase">
							<li><a href="" class="active">控制面板</a></li>
							<!--			<li><a href="">Dashboard</a></li>-->
							<!--			<li><a href="">Overview</a></li>-->
							<!--			<li><a href="login.html">Sign in form</a></li>-->
						</ul>
					</nav>
				</div>
			</div>




			<div class="templatemo-content-container">
				<div class="templatemo-content-widget white-bg" style="height: 1325px;text-align: center;">
					<h1 class="margin-bottom-10">查询界面</h1>
					<p class="margin-bottom-0"><a href="http://www.baidu.com" target="_parent">供应链追踪</a></p>
					<div>
						<input type="text" id="query" placeholder="请输入你要查询的区域">
						<button id="confrim">查询</button>
						<button id="draw" style="width: 80px; height: 35px;">确定坐标</button>
					</div>
					<div id="undetermined"
						style="background-color: #f5f5f5;width: 950px;height: 400px;margin: 20px auto"></div>
					<div id="queryOutput"
						style="background-color: #f5f5f5;width: 950px;height: 550px;margin: 20px auto;text-align: left">
						<div class="row">
							<div class="col-12">
								<div class="card m-b-30">
									<div class="card-body">

										<h4 class="mt-0 header-title">&nbsp;&nbsp;&nbsp;状态信息</h4>
<!--										<p class="text-muted m-b-30 font-14">-->
<!--										</p>-->

<!--										<div id="datatable-buttons_wrapper" class="dataTables_wrapper container-fluid dt-bootstrap4 no-footer">-->
<!--											<div class="row"><div class="col-sm-12 col-md-6"><div class="dt-buttons btn-group">-->
<!--												<a class="btn btn-secondary buttons-copy buttons-html5" tabindex="0" aria-controls="datatable-buttons" href="#">-->
<!--													<span>Copy</span></a><a class="btn btn-secondary buttons-excel buttons-html5" tabindex="0" aria-controls="datatable-buttons" href="#"><span>Excel</span></a><a class="btn btn-secondary buttons-pdf buttons-html5" tabindex="0" aria-controls="datatable-buttons" href="#">-->
<!--												<span>PDF</span></a><a class="btn btn-secondary buttons-collection dropdown-toggle buttons-colvis" tabindex="0" aria-controls="datatable-buttons" href="#"><span>Column visibility</span></a></div></div><div class="col-sm-12 col-md-6"><div id="datatable-buttons_filter" class="dataTables_filter"><label>Search:<input type="search" class="form-control form-control-sm" placeholder="" aria-controls="datatable-buttons"></label></div></div></div>-->
<!--											<div class="row"><div class="col-sm-12">-->
											<table id="datatable-buttons" class="table table-striped table-bordered dataTable no-footer" cellspacing="0" width="100%" role="grid" aria-describedby="datatable-buttons_info" style="width: 97%;height:90%;margin: 0 auto">
											<thead>
											<tr role="row"><th class="sorting_asc" tabindex="0" aria-controls="datatable-buttons" rowspan="1" colspan="1" aria-sort="ascending" aria-label="Name: activate to sort column descending" style="width: 200px;"> latitude</th>
												<th class="sorting" tabindex="0" aria-controls="datatable-buttons" rowspan="1" colspan="1" aria-label="Position: activate to sort column ascending" style="width: 200px;"> longitude </th>
												<th class="sorting" tabindex="0" aria-controls="datatable-buttons" rowspan="1" colspan="1" aria-label="Office: activate to sort column ascending" style="width: 150px;"> temperature</th>
												<th class="sorting" tabindex="0" aria-controls="datatable-buttons" rowspan="1" colspan="1" aria-label="Age: activate to sort column ascending" style="width: 150px;">humidity</th>
												<th class="sorting" tabindex="0" aria-controls="datatable-buttons" rowspan="1" colspan="1" aria-label="Start date: activate to sort column ascending" style="width: 230px;">date</th>
<!--												<th class="sorting" tabindex="0" aria-controls="datatable-buttons" rowspan="1" colspan="1" aria-label="Salary: activate to sort column ascending" style="width: 109px;">Salary</th></tr>-->
											</thead>
											<tbody>
											<tr role="row" class="odd">
												<td class="sorting_1 data_1"></td>
												<td class="data_2"></td>
												<td class="data_3"></td>
												<td class="data_4"></td>
												<td class="data_5"></td>
<!--												<td>$162,700</td>-->
											</tr>
												<tr role="row" class="even">
												<td class="sorting_1">116°E</td>
												<td>36°N</td>
												<td>32°C</td>
												<td>37%</td>
												<td>2020/05/08 10:52:11 AM</td>
<!--												<td>$1,200,000</td>-->
											</tr><tr role="row" class="odd">
												<td class="sorting_1">116°E</td>
												<td>36°N</td>
												<td>32°C</td>
												<td>40%</td>
												<td>2020/05/08 10:42:35 AM</td>
<!--												<td>$86,000</td>-->
											</tr><tr role="row" class="even">
												<td class="sorting_1">116°E</td>
												<td>40°N</td>
												<td>26°C</td>
												<td>47%</td>
												<td>2021/07/09 07:32:01 AM</td>
<!--												<td>$132,000</td>-->
											</tr><tr role="row" class="odd">
												<td class="sorting_1">116°E</td>
												<td>40°N</td>
												<td>33°C</td>
												<td>60%</td>
												<td>2021/07/11 09:02:56 AM</td>
<!--												<td>$206,850</td>-->
											</tr><tr role="row" class="even">
												<td class="sorting_1">116°E</td>
												<td>40°N</td>
												<td>30°C</td>
												<td>66%</td>
												<td>2021/07/12 11:20:41 AM</td>
<!--												<td>$372,000</td>-->
											</tr><tr role="row" class="odd">
												<td class="sorting_1">116°E</td>
												<td>40°N</td>
												<td>30°C</td>
												<td>78%</td>
												<td>2021/07/13 18:38:23 PM</td>
<!--												<td>$163,500</td>-->
											</tr><tr role="row" class="even">
												<td class="sorting_1">116°E</td>
												<td>40°N</td>
												<td>32°C</td>
												<td>74%</td>
												<td>2021/07/13 14:32:31 PM</td>
<!--												<td>$106,450</td>-->
											</tr><tr role="row" class="odd">
												<td class="sorting_1">116°E</td>
												<td>40°N</td>
												<td>35°C</td>
												<td>78%</td>
												<td>2021/07/13 20:06:58 PM</td>
<!--												<td>$145,600</td>-->
											</tr><tr role="row" class="even">
												<td class="sorting_1">116°E</td>
												<td>40°N</td>
												<td>26°C</td>
												<td>70%</td>
												<td>2021/07/13 13:57:20 PM</td>
<!--												<td>$433,060</td>-->
											</tr></tbody>
										</table></div></div><div class="row"><div class="col-sm-12 col-md-5"><div class="dataTables_info" id="datatable-buttons_info" role="status" aria-live="polite">&nbsp;&nbsp;&nbsp;&nbsp;Showing 1 to 10 of 57 entries</div></div>
								<div class="col-sm-12 col-md-7" style="">
									<div class="dataTables_paginate paging_simple_numbers" id="datatable-buttons_paginate">
									<ul class="pagination">
										<li class="paginate_button page-item previous disabled" id="datatable-buttons_previous"><a href="#" aria-controls="datatable-buttons" data-dt-idx="0" tabindex="0" class="page-link">Previous</a></li>
									<li class="paginate_button page-item active">
										<a href="#" aria-controls="datatable-buttons" data-dt-idx="1" tabindex="0" class="page-link">1</a></li>
									<li class="paginate_button page-item "><a href="#" aria-controls="datatable-buttons" data-dt-idx="2" tabindex="0" class="page-link">2</a></li><li class="paginate_button page-item ">
										<a href="#" aria-controls="datatable-buttons" data-dt-idx="3" tabindex="0" class="page-link">3</a></li><li class="paginate_button page-item ">
										<a href="#" aria-controls="datatable-buttons" data-dt-idx="4" tabindex="0" class="page-link">4</a></li>
									<li class="paginate_button page-item ">
										<a href="#" aria-controls="datatable-buttons" data-dt-idx="5" tabindex="0" class="page-link">5</a></li>
									<li class="paginate_button page-item "><a href="#" aria-controls="datatable-buttons" data-dt-idx="6" tabindex="0" class="page-link">6</a></li>
									<li class="paginate_button page-item next" id="datatable-buttons_next"><a href="#" aria-controls="datatable-buttons" data-dt-idx="7" tabindex="0" class="page-link">Next</a></li></ul></div></div></div></div>

									</div>
								</div>
							</div> <!-- end col -->
						</div>
					</div>

				</div>
				<footer class="text-right">
<!--					<p>Designed by NEQUCSA作品组</a></p>-->
				</footer>
			</div>
		</div>
	</div>

	<!-- JS -->
	<script type="text/javascript" src="js/jquery-1.11.2.min.js"></script> <!-- jQuery -->
	<script type="text/javascript" src="js/jquery-migrate-1.2.1.min.js"></script> <!--  jQuery Migrate Plugin -->
	<script type="text/javascript" src="js/templatemo-script.js"></script> <!-- Templatemo Script -->
	<script type="text/javascript" src="jqvmap/jquery.vmap.js"></script>
	<script type="text/javascript" src="jqvmap/maps/jquery.vmap.world.js"></script>
	<script type="text/javascript" src="jqvmap/data/jquery.vmap.sampledata.js"></script>
	<script src="jqvmap/maps/continents/jquery.vmap.africa.js" type="text/javascript"></script>
	<script src="jqvmap/maps/continents/jquery.vmap.asia.js" type="text/javascript"></script>
	<script src="jqvmap/maps/continents/jquery.vmap.australia.js" type="text/javascript"></script>
	<script src="jqvmap/maps/continents/jquery.vmap.europe.js" type="text/javascript"></script>
	<script src="jqvmap/maps/continents/jquery.vmap.north-america.js" type="text/javascript"></script>
	<script src="jqvmap/maps/continents/jquery.vmap.south-america.js" type="text/javascript"></script>
	<script src="jqvmap/maps/jquery.vmap.usa.js" type="text/javascript"></script>
	<script type="text/javascript">

	</script>
	<script>
		var checkKey = "0x53fD27EE81cD5868153916666aFC23F5ce14cb2e";

		function sleep(ms) {
			for (var t = Date.now(); Date.now() - t <= ms;);
		}


		$(function () {
			// 地图API
			var map = new BMap.Map("undetermined");    // 创建Map实例
			map.centerAndZoom(new BMap.Point(121.80, 30.922985), 16);  // 初始化地图,设置中心点坐标和地图级别
			//添加地图类型控件
			map.addControl(new BMap.MapTypeControl({
				mapTypes: [
					BMAP_NORMAL_MAP,
					BMAP_HYBRID_MAP
				]
			}));
			map.setCurrentCity("临沂");          // 设置地图显示的城市 此项是必须设置的y
			map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放
			console.log(x1);
			console.log(y1);
			var marker1 = new BMap.Marker(new BMap.Point(x1, y1));
			map.addOverlay(marker1);

			// var web3Provider;
			// // console.log(window.ethereum);
			// if (window.ethereum) {
			// 	web3Provider = window.ethereum;
			// 	try {
			// 		// 请求用户授权
			// 		window.ethereum.enable();
			// 	} catch (error) {
			// 		// 用户不授权时
			// 		console.error("User denied account access")
			// 	}
			// }
			// web3 = new Web3(web3Provider);//构建web3实例
			// console.log(web3Provider);
			//
			// web3.eth.getAccounts(function (error, result) {
			// 	if (!error) {
			// 		checkKey = "" + result;
			// 		console.log(checkKey);
			// 	}
			// });
		})

		// var Web3 = require('web3');
		const provider = new Web3.providers.WebsocketProvider("ws://59.110.220.18:8546")
		var web3 = new Web3(provider);

		const abi = [
			{
				"constant": true,
				"inputs": [],
				"name": "x",
				"outputs": [
					{
						"name": "",
						"type": "string"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": false,
				"inputs": [
					{
						"name": "_jobId",
						"type": "bytes32"
					}
				],
				"name": "requestTemperature",
				"outputs": [
					{
						"name": "requestId",
						"type": "bytes32"
					}
				],
				"payable": false,
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"constant": false,
				"inputs": [
					{
						"name": "_requestId",
						"type": "bytes32"
					},
					{
						"name": "_temp",
						"type": "bytes32"
					}
				],
				"name": "fulfillTemperature",
				"outputs": [],
				"payable": false,
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [],
				"name": "date",
				"outputs": [
					{
						"name": "",
						"type": "string"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": false,
				"inputs": [],
				"name": "getData",
				"outputs": [
					{
						"name": "",
						"type": "string"
					}
				],
				"payable": false,
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [
					{
						"name": "x",
						"type": "bytes32"
					}
				],
				"name": "bytes32ToString",
				"outputs": [
					{
						"name": "",
						"type": "string"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [],
				"name": "humidity",
				"outputs": [
					{
						"name": "",
						"type": "string"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [],
				"name": "y",
				"outputs": [
					{
						"name": "",
						"type": "string"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [],
				"name": "temperature",
				"outputs": [
					{
						"name": "",
						"type": "string"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": false,
				"inputs": [],
				"name": "fulfillHumidity",
				"outputs": [],
				"payable": false,
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"constant": false,
				"inputs": [],
				"name": "geDateData",
				"outputs": [
					{
						"name": "",
						"type": "string"
					}
				],
				"payable": false,
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"name": "temperatureContractAddress",
						"type": "address"
					},
					{
						"name": "humidityContractAddress",
						"type": "address"
					},
					{
						"name": "xContractAddress",
						"type": "address"
					},
					{
						"name": "yContractAddress",
						"type": "address"
					}
				],
				"payable": false,
				"stateMutability": "nonpayable",
				"type": "constructor"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"name": "id",
						"type": "bytes32"
					}
				],
				"name": "ChainlinkRequested",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"name": "id",
						"type": "bytes32"
					}
				],
				"name": "ChainlinkFulfilled",
				"type": "event"
			},
			{
				"anonymous": false,
				"inputs": [
					{
						"indexed": true,
						"name": "id",
						"type": "bytes32"
					}
				],
				"name": "ChainlinkCancelled",
				"type": "event"
			}
		]
		const _address = '0xd056A83030614b3b3c39C5764ad9f36c8377c7F9';
		// const url = 'http://47.93.102.224/other/getData';
		var myContract = new web3.eth.Contract(abi,_address);

		var x1;
		var y1;
		$('#confrim').click(function () {

			// var myContarct = new web3.eth.Contract(abi, _address, { from: checkKey });
			var receiptBlockHash = "交易requestVolumeData的区块hash是: ";
			var temperature = "";
			var humidity = "";
			var x = "";
			var y = "";
			var date = "";
			const rerequestVolumeData = async () => {
				await myContract.methods.fulfillHumidity().send({ from: checkKey }).then(function (receipt) {
					console.log(receipt);
					receiptBlockHash = receiptBlockHash + receipt.blockHash + '<br>';
					// $('#queryOutput').append(receiptBlockHash);
					sleep(5000);
					getTemperature();
					sleep(2000);
					gethumidity();
					sleep(2000);
					getX();
					sleep(2000);
					getY();
					sleep(2000);
					getDate();

				});
				// console.log(await myContarct.methods.store(2).send({from: checkKey}));
			}
			const getTemperature = async () => {
				await myContract.methods.temperature().call({ from: checkKey }).then(function (res) {
					console.log(res);
					temperature = temperature + res + '<br>';
					$('.data_1').append(temperature);
				})
			}
			const gethumidity = async () => {
				await myContract.methods.humidity().call({ from: checkKey }).then(function (res) {
					console.log(res);
					humidity = humidity + res + '<br>';
					$('.data_2').append(humidity);
				})
			}
			const getX = async () => {
				await myContract.methods.x().call({ from: checkKey }).then(function (res) {
					console.log(res);
					x1 = res;
					console.log(x1);
					x = x + res + '<br>';
					$('.data_3').append(x);
				})
			}
			const getY = async () => {
				await myContract.methods.y().call({ from: checkKey }).then(function (res) {
					console.log(res);
					y1 = res;
					console.log(y1)
					y = y + res + '<br>';
					$('.data_4').append(y);
				})
			}
			const getDate = async () => {
				await myContract.methods.date().call({ from: checkKey }).then(function (res) {
					console.log(res);
					date = date + res + '<br>';
					$('.data_5').append(date);
				})
			}
			rerequestVolumeData();
		})

		$('#confrim1').click(function (){
			var data = new Array();
			const sendAndgetEvent = async () => {
				await web3.eth.getBalance(checkKey,function (err,res){
					if(!err){
						console.log(web3.utils.fromWei(res));
					}
				})
				await myContract.methods.getData().send({from:checkKey}).then(function(receipt){
					console.log("succeed");
					myContract.events.receiveData({fromBlock:'latest'},function(err,res){
						if(!err){
							 console.log(res);
						}
					}).on('data',function(event){
						console.log("data: " + event.returnValues._data);
						data[0] = event.returnValues._data;
					})
				});
			}
			sendAndgetEvent();
		})

		$('#draw').click(function (){
			var map = new BMap.Map("undetermined");    // 创建Map实例
			map.centerAndZoom(new BMap.Point(119.556608, 39.922985), 16);  // 初始化地图,设置中心点坐标和地图级别
			//添加地图类型控件
			map.addControl(new BMap.MapTypeControl({
				mapTypes: [
					BMAP_NORMAL_MAP,
					BMAP_HYBRID_MAP
				]
			}));
			map.setCurrentCity("临沂");          // 设置地图显示的城市 此项是必须设置的y
			map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放
			console.log(x1);
			console.log(y1);
			var marker1 = new BMap.Marker(new BMap.Point(x1, y1));
			map.addOverlay(marker1);
		})



	</script>
</body>

</html>